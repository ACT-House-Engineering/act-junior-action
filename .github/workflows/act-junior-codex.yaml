name: 🌼 ACT Junior Codex (WIP)

# Add permissions here for the whole workflow
permissions:
  contents: write # Needed to commit changes
  pull-requests: write # Needed to create the PR
  issues: read # Needed for issue_comment trigger context

on:
  workflow_dispatch:
  issue_comment:
    types: [created]
  push:
    branches:
      - main

jobs:
  ci:
    # Condition to run only on issue comments (not PRs)
    # containing the trigger phrase
    if: >
      github.event.issue.pull_request == null &&
      contains(github.event.comment.body, '/update-changelog')
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout code
        uses: actions/checkout@v4
        with:
          # Checkout main branch explicitly
          ref: main

      - name: 📦 Install Correct Node Version
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json

      - name: 📦 Setup PNPM and Install dependencies
        uses: pnpm/action-setup@v4
        with:
          run_install: true
          version: latest

      - name: 🌼 Update changelog via Codex
        run: |
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          # TODO: Update prompt based on issue context?
          pnpm codex -a auto-edit --quiet "Update the README.md file with the latest changes"

      # Add this step to check git status
      - name: 🔍 Check for changes
        run: git status

      # Add this step to create the PR
      - name: ✨ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          # Use a PAT if you need the PR to trigger
          # other workflows.
          token: ${{ secrets.PAT_GITHUB }}
          # token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update CHANGELOG.md"
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          branch: chore/update-changelog # Branch name
          delete-branch: true # Delete branch after PR merge
          title: 'chore: Update CHANGELOG.md'
          body: |
            Automated update of CHANGELOG.md requested in #${{ github.event.issue.number }}.

            Triggered by @${{ github.actor }} in comment: ${{ github.event.comment.html_url }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          labels: automated pr, changelog
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}
          draft: false

  # New job to test codex cli on main push
  test-codex:
    # Run only on push to main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: 🛒 Checkout code
        uses: actions/checkout@v4

      - name: 📦 Install Correct Node Version
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json

      - name: 📦 Setup PNPM and Install dependencies
        uses: pnpm/action-setup@v4
        with:
          run_install: true
          version: latest

      - name: 🧪 Verify Codex CLI execution
        run: |
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          # Use a simple, non-editing command
          pnpm codex --quiet "Explain the purpose of a CHANGELOG.md file"