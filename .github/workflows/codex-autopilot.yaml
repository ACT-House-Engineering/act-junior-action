############################################################################################################
# IMPORTANT - READ ME FIRST ğŸ›‘
#
# Read more: https://bradenkeith.com/automate-aipowered-fixes-with-codexautopilot.html
#
# This workflow opens pull requests with the builtâ€‘in `GITHUB_TOKEN`.
#   âœ REPO / ORG Settings â–¸ Actions â–¸ Workflow permissions
#   âœ Tick â€œ**Allow GitHub Actions to create and approve pull requests**â€ and click Save.
#
# If that option cannot be enabled (e.g. org policy), replace `${{ secrets.GITHUB_TOKEN }}`
# with a fineâ€‘grained Personal Access Token (PAT) that has:
#   â€¢ contents: read & write
#   â€¢ pullâ€‘requests: read & write
############################################################################################################

name: codex-autopilot

on:
  issues:
    types: [labeled]

permissions:
  contents: write          # let the action commit & push
  pull-requests: write
  issues: write
  statuses: write

jobs:
  codex:
    if: ${{ github.event.label.name == 'codex' }}
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ISSUE_TITLE:  ${{ github.event.issue.title }}
      ISSUE_BODY:   ${{ github.event.issue.body }}
      BRANCH_NAME:  codex/${{ github.event.issue.number }}

    steps:
      # ğŸ‘€ Tell the reporter we picked it up
      - name: React with eyes emoji
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            await github.rest.reactions.createForIssue({
              owner,
              repo,
              issue_number,
              content: 'eyes'    // ğŸ‘€
            });
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0         # needed so the action can create a branch

      - name: Set up Node 22 and Codex
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Codex
        run: |
          npm install -g @openai/codex
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #  Make your modifications (Codex or otherwise)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Codex in non-interactive CI mode
        run: |
          PROMPT="${ISSUE_TITLE}\n\n${ISSUE_BODY}"
          codex -a auto-edit -m codex-mini-latest --w docs/ --quiet --flex-mode "$PROMPT"
      # after your "Run Codexâ€¦" step, before createâ€‘pullâ€‘request
      - name: Force origin to HTTPS with token
        run: |
          git config --local user.email "github-actions[codex-bot]@users.noreply.github.com"
          git config --local user.name "github-actions[codex-bot]"
          git remote set-url origin \
            https://x-access-token:${{ secrets.PAT_GITHUB }}@github.com/${{ github.repository }}.git
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #  Commit + push + open PR (all handled by the action)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          author:        "github-actions[codex-bot] <github-actions[codex-bot]@users.noreply.github.com>"
          branch:        ${{ env.BRANCH_NAME }}        # new or existing
          base:          main                          # PR target
          commit-message: "Codex: ${{ env.ISSUE_TITLE }} (fixes #${{ github.event.issue.number }})"
          title:         "Codex: ${{ env.ISSUE_TITLE }}"
          body: |
            Automated changes generated by Codex for **#${{ github.event.issue.number }}**.
            ---
            _This PR was created by the **codex-autopilot** workflow._
          delete-branch: true                          # tidy up after merge
          token:         ${{ secrets.PAT_GITHUB }}   # gets write perms from `permissions:` above